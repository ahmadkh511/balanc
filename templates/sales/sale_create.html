{% load static %}
<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>إنشاء فاتورة بيع</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 100%;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .barcode-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .barcode-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 120px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        .delete-btn {
            background-color: #f44336;
        }
    </style>
</head>
<body dir="rtl">
    <div class="container">
        <h1>إنشاء فاتورة بيع</h1>
        <form method="post" id="sale-form">
            {% csrf_token %}
            
            <!-- معلومات الفاتورة الأساسية -->
            <table>
                <tr>
                    <th>{{ form.sale_date.label_tag }}</th>
                    <td>{{ form.sale_date }}</td>
                    <th>{{ form.sale_customer.label_tag }}</th>
                    <td>{{ form.sale_customer }}</td>
                </tr>
                <tr>
                    <th>{{ form.sale_customer_phone.label_tag }}</th>
                    <td>{{ form.sale_customer_phone }}</td>
                    <th>{{ form.sale_notes.label_tag }}</th>
                    <td>{{ form.sale_notes }}</td>
                </tr>
            </table>

            <!-- مواد الفاتورة -->
            <table id="items-table">
                <thead>
                    <tr>
                        <th>المادة</th>
                        <th>الكمية</th>
                        <th>سعر الوحدة</th>
                        <th>الإجمالي</th>
                        <th>حذف</th>
                    </tr>
                </thead>
                <tbody>
                    {{ formset.management_form }}
                    {% for form in formset %}
                        <tr class="item-row">
                            <td>{{ form.item_name }}</td>
                            <td>{{ form.quantity }}</td>
                            <td>{{ form.unit_price }}</td>
                            <td class="total-price">0.00</td>
                            <td><button type="button" class="delete-btn">حذف</button></td>
                        </tr>
                        <tr>
                            <td colspan="5">
                                <div class="barcode-container" id="barcodes-{{ forloop.counter0 }}"></div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <button type="button" id="add-item">إضافة مادة</button>
            <button type="submit">حفظ الفاتورة</button>
        </form>
    </div>

    <script>
        $(document).ready(function() {
            // إضافة صف جديد
            $('#add-item').click(function() {
                const formCount = $('#id_form-TOTAL_FORMS').val();
                const newForm = $('.item-row:first').clone();
                
                // تحديث المعرفات
                newForm.find(':input').each(function() {
                    const name = $(this).attr('name').replace(/-\d+-/, `-${formCount}-`);
                    const id = $(this).attr('id').replace(/_\d+_/, `_${formCount}_`);
                    $(this).attr({ name, id }).val('');
                });
                
                newForm.find('.total-price').text('0.00');
                
                // إضافة الصف الجديد
                $('#items-table tbody').append(newForm);
                $('#items-table tbody').append(`<tr><td colspan="5"><div class="barcode-container" id="barcodes-${formCount}"></div></td></tr>`);
                
                // زيادة العداد
                $('#id_form-TOTAL_FORMS').val(parseInt(formCount) + 1);
            });
            
            // حذف صف
            $(document).on('click', '.delete-btn', function() {
                const row = $(this).closest('.item-row');
                const barcodeRow = row.next();
                row.remove();
                barcodeRow.remove();
            });
            
            // تحديث الباركودات عند تغيير الكمية
            $(document).on('change', 'input[id$="-quantity"]', function() {
                const index = $(this).attr('id').split('-')[1];
                const quantity = parseInt($(this).val()) || 0;
                const container = $(`#barcodes-${index}`);
                container.empty();
                
                for (let i = 0; i < quantity; i++) {
                    container.append(`<input type="text" name="barcodes_${index}" class="barcode-input" placeholder="باركود ${i+1}">`);
                }
            });
            
            // حساب الإجمالي عند تغيير الكمية أو السعر
            $(document).on('change', 'input[id$="-quantity"], input[id$="-unit_price"]', function() {
                const row = $(this).closest('.item-row');
                const quantity = parseFloat(row.find('input[id$="-quantity"]').val()) || 0;
                const unitPrice = parseFloat(row.find('input[id$="-unit_price"]').val()) || 0;
                const total = quantity * unitPrice;
                row.find('.total-price').text(total.toFixed(2));
            });
        });
    </script>
</body>
</html>

<!-- نسخة الكود يعمل   و الحفظ يعمل -->