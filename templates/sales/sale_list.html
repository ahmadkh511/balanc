{% extends 'base.html' %}
{% load static humanize %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- العنوان وأزرار التحكم -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-file-invoice-dollar text-primary me-2"></i> قائمة فواتير المبيعات
        </h1>
        <div class="d-flex">
            <a href="{% url 'sale_create' %}" class="btn btn-primary btn-sm me-2" {% if not perms.sales.add_sale %}disabled title="ليس لديك صلاحية إضافة فواتير"{% endif %}>
                <i class="fas fa-plus me-1"></i> فاتورة جديدة
            </a>
            <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" id="searchInput" class="form-control" placeholder="ابحث..." aria-label="Search">
                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- فلترة متقدمة -->
    <div class="card mb-4">
        <div class="card-body py-2">
            <form method="get" class="row g-2 align-items-center">
                <div class="col-md-2">
                    <select name="status" class="form-select form-select-sm">
                        <option value="">كل الحالات</option>
                        {% for status in statuses %}
                        <option value="{{ status.id }}" {% if request.GET.status == status.id|stringformat:"s" %}selected{% endif %}>{{ status.status_types }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="small text-muted mb-1">من تاريخ</label>
                    <input type="date" name="date_from" class="form-control form-control-sm" value="{{ request.GET.date_from }}">
                </div>
                <div class="col-md-2">
                    <label class="small text-muted mb-1">إلى تاريخ</label>
                    <input type="date" name="date_to" class="form-control form-control-sm" value="{{ request.GET.date_to }}">
                </div>
                <div class="col-md-2">
                    <select name="payment_method" class="form-select form-select-sm">
                        <option value="">كل طرق الدفع</option>
                        {% for method in payment_methods %}
                        <option value="{{ method.id }}" {% if request.GET.payment_method == method.id|stringformat:"s" %}selected{% endif %}>{{ method.payment_method_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-sm btn-primary w-100 mt-3">
                        <i class="fas fa-filter me-1"></i> تطبيق
                    </button>
                </div>
                <div class="col-md-2">
                    <a href="{% url 'sale_list' %}" class="btn btn-sm btn-outline-secondary w-100 mt-3">
                        <i class="fas fa-undo me-1"></i> إعادة تعيين
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- الإحصائيات -->
    <div class="card mb-4">
        <div class="card-body p-3">
            <div class="row">
                <div class="col-md-3 border-end">
                    <div class="text-center">
                        <h6 class="text-muted">عدد الفواتير</h6>
                        <h4 class="text-primary">{{ page_obj.paginator.count|intcomma }}</h4>
                    </div>
                </div>
                <div class="col-md-3 border-end">
                    <div class="text-center">
                        <h6 class="text-muted">إجمالي المبيعات</h6>
                        <h4 class="text-success">{{ total_sales|default:0|floatformat:2|intcomma }} ر.س</h4>
                    </div>
                </div>
                <div class="col-md-3 border-end">
                    <div class="text-center">
                        <h6 class="text-muted">متوسط الفاتورة</h6>
                        <h4 class="text-info">{{ avg_sale|default:0|floatformat:2|intcomma }} ر.س</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h6 class="text-muted">أعلى فاتورة</h6>
                        <h4 class="text-warning">{{ max_sale|default:0|floatformat:2|intcomma }} ر.س</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- جدول الفواتير -->
    <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">فواتير المبيعات</h6>
            <button id="toggle-all-details" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-expand-alt me-1"></i> فتح/إغلاق الكل
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="50px"></th>
                            <th width="150px">رقم الفاتورة</th>
                            <th>العميل</th>
                            <th width="120px">التاريخ</th>
                            <th width="120px">الحالة</th>
                            <th width="120px">طريقة الدفع</th>
                            <th width="130px">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sale in page_obj %}
                        <!-- الصف الأساسي -->
                        <tr class="sale-row" style="border-bottom: 2px solid #f1f1f1;">
                            <td>
                                <button class="btn btn-sm btn-outline-primary toggle-details" 
                                        data-sale-id="{{ sale.id }}"
                                        title="عرض/إخفاء التفاصيل">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </td>
                            <td class="fw-bold">{{ sale.uniqueId }}</td>
                            <td>{{ sale.sale_customer.get_full_name|default:sale.sale_customer.username }}</td>
                            <td>{{ sale.sale_date|date:"Y-m-d" }}</td>
                            <td>
                                <span class="badge 
                                    {% if sale.sale_status.status_types == 'مكتمل' %}bg-success
                                    {% elif sale.sale_status.status_types == 'معلق' %}bg-warning
                                    {% elif sale.sale_status.status_types == 'ملغى' %}bg-danger
                                    {% else %}bg-info{% endif %}">
                                    {{ sale.sale_status.status_types }}
                                </span>
                            </td>
                            <td>{{ sale.sale_payment_method.payment_method_name|default:"-" }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'sale_detail' sale.id %}" class="btn btn-info" title="عرض التفاصيل">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if perms.sales.change_sale %}
                                    <a href="{% url 'sale_update' sale.id %}" class="btn btn-primary" title="تعديل">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}
                                    <a href="#" class="btn btn-secondary" title="طباعة">
                                        <i class="fas fa-print"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- صف التفاصيل (مخفي بالبداية) -->
                        <tr class="details-row" id="details-{{ sale.id }}" style="display: none;">
                            <td colspan="7">
                                <div class="p-3">
                                    <!-- السطر الثاني: معلومات إضافية -->
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold">العنوان:</span>
                                                <span>{{ sale.sale_address|default:"-" }}</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold">رقم الهاتف:</span>
                                                <span>{{ sale.sale_customer_phone|default:"-" }}</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold">شركة الشحن:</span>
                                                <span>{{ sale.sale_shipping_company.shipping_company_name|default:"-" }}</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold">رقم الإشعار:</span>
                                                <span>{{ sale.sale_shipping_num|default:"-" }}</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold">الملاحظات:</span>
                                                <span>{{ sale.sale_notes|default:"-" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- السطر الثالث: جدول الأصناف -->
                                    <div class="table-responsive mb-3">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th width="30%">الصنف</th>
                                                    <th width="15%">الكمية</th>
                                                    <th width="15%">السعر</th>
                                                    <th width="15%">الإجمالي</th>
                                                    <th width="15%">الصورة</th>
                                                    <th width="10%">ملاحظات</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in sale.items.all %}
                                                <tr>
                                                    <td>{{ item.item_name }}</td>
                                                    <td>{{ item.quantity }}</td>
                                                    <td>{{ item.unit_price|floatformat:2 }} ر.س</td>
                                                    <td>{{ item.sale_total|floatformat:2 }} ر.س</td>
                                                    <td>
                                                        {% if item.sale_item_image %}
                                                        <img src="{{ item.sale_item_image.url }}" class="img-thumbnail" style="max-height: 50px;">
                                                        {% else %}
                                                        -
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ item.notes|default:"-" }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- السطر الرابع: الباركودات -->
                                    <div class="mb-3">
                                        <h6 class="fw-bold mb-2">الباركودات:</h6>
                                        <div class="d-flex flex-wrap gap-2">
                                            {% for item in sale.items.all %}
                                                {% for barcode in item.saleitembarcode_set.all %}
                                                <div class="barcode-item p-2 border rounded">
                                                    <span class="badge bg-secondary me-1">{{ item.item_name }}</span>
                                                    <span class="barcode-value">{{ barcode.barcode.barcode_out }}</span>
                                                    {% if barcode.is_primary %}
                                                    <span class="badge bg-success ms-1">رئيسي</span>
                                                    {% endif %}
                                                    <button class="btn btn-sm btn-outline-dark copy-btn ms-1" 
                                                            data-barcode="{{ barcode.barcode.barcode_out }}"
                                                            title="نسخ الباركود">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                {% endfor %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- السطر الخامس: الحسابات النهائية -->
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="d-flex justify-content-between border-bottom py-1">
                                                <span>المجموع الفرعي:</span>
                                                <span class="fw-bold">{{ sale.subtotal|default:0|floatformat:2 }} ر.س</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex justify-content-between border-bottom py-1">
                                                <span>الخصم العام:</span>
                                                <span class="fw-bold text-danger">- {{ sale.sale_global_discount|default:0|floatformat:2 }} ر.س</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex justify-content-between border-bottom py-1">
                                                <span>الإضافة العامة:</span>
                                                <span class="fw-bold text-success">+ {{ sale.sale_global_addition|default:0|floatformat:2 }} ر.س</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex justify-content-between border-bottom py-1">
                                                <span>المجموع بعد الخصم/الإضافة:</span>
                                                <span class="fw-bold">{{ sale.subtotal_after_discount|default:0|floatformat:2 }} ر.س</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex justify-content-between border-bottom py-1">
                                                <span>نسبة الضريبة:</span>
                                                <span class="fw-bold">{{ sale.sale_global_tax|default:0|floatformat:2 }}%</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex justify-content-between border-bottom py-1">
                                                <span>قيمة الضريبة:</span>
                                                <span class="fw-bold">{{ sale.sale_tax_amount|default:0|floatformat:2 }} ر.س</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex justify-content-between border-bottom py-1">
                                                <span>المبلغ بعد الضريبة:</span>
                                                <span class="fw-bold">{{ sale.sale_after_tax|default:0|floatformat:2 }} ر.س</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex justify-content-between py-1 bg-light rounded">
                                                <span class="fw-bold">الإجمالي النهائي:</span>
                                                <span class="fw-bold text-primary">{{ sale.sale_total_amount|default:0|floatformat:2 }} ر.س</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4">لا توجد فواتير لعرضها</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="7" class="text-end">
                                <div class="row p-3">
                                    <div class="col-md-6">
                                        <div class="d-flex justify-content-between border-bottom py-2">
                                            <span class="fw-bold">إجمالي الصفحة الحالية:</span>
                                            <span class="fw-bold text-primary">{{ page_total|default:0|floatformat:2 }} ر.س</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex justify-content-between border-bottom py-2">
                                            <span class="fw-bold">الإجمالي العام:</span>
                                            <span class="fw-bold text-success">{{ total_sales|default:0|floatformat:2 }} ر.س</span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- الترقيم المخصص -->
    {% if page_obj.paginator.num_pages > 1 %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="الأولى">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="السابق">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="التالي">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="الأخيرة">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            {% endif %}
        </ul>
        <div class="text-center text-muted mt-2">
            عرض {{ page_obj.start_index }} - {{ page_obj.end_index }} من أصل {{ page_obj.paginator.count }} فاتورة
        </div>
    </nav>
    {% endif %}
</div>

<!-- مكتبات إضافية -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
$(document).ready(function() {
    // نسخ الباركود
    $('.copy-btn').click(function() {
        const barcode = $(this).data('barcode');
        navigator.clipboard.writeText(barcode).then(() => {
            const icon = $(this).find('i');
            icon.removeClass('fa-copy').addClass('fa-check');
            
            setTimeout(() => {
                icon.removeClass('fa-check').addClass('fa-copy');
            }, 2000);
            
            Toastify({
                text: "تم نسخ الباركود: " + barcode,
                duration: 2000,
                className: "bg-info",
                close: true,
                gravity: "top",
                position: "left"
            }).showToast();
        });
    });

    // تبديل عرض التفاصيل
    $('.toggle-details').click(function() {
        const saleId = $(this).data('sale-id');
        const detailsRow = $('#details-' + saleId);
        const icon = $(this).find('i');
        
        detailsRow.toggle();
        
        if (detailsRow.is(':visible')) {
            icon.removeClass('fa-plus').addClass('fa-minus');
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
        } else {
            icon.removeClass('fa-minus').addClass('fa-plus');
            $(this).removeClass('btn-primary').addClass('btn-outline-primary');
        }
    });

    // فتح/إغلاق كل التفاصيل
    $('#toggle-all-details').click(function() {
        const allDetails = $('.details-row');
        const allButtons = $('.toggle-details');
        const allIcons = $('.toggle-details i');
        
        if (allDetails.first().is(':visible')) {
            allDetails.hide();
            allButtons.removeClass('btn-primary').addClass('btn-outline-primary');
            allIcons.removeClass('fa-minus').addClass('fa-plus');
        } else {
            allDetails.show();
            allButtons.removeClass('btn-outline-primary').addClass('btn-primary');
            allIcons.removeClass('fa-plus').addClass('fa-minus');
        }
    });

    // البحث في الجدول
    $("#searchInput").on("keyup", function() {
        const value = $(this).val().toLowerCase();
        let visibleRows = 0;
        
        $(".sale-row").each(function() {
            const isMatch = $(this).text().toLowerCase().includes(value);
            $(this).toggle(isMatch);
            $(this).next(".details-row").toggle(isMatch);
            
            if (isMatch) visibleRows++;
        });
        
        if (visibleRows === 0) {
            $("#no-results").remove();
            $("tbody").append('<tr id="no-results"><td colspan="7" class="text-center">لا توجد نتائج مطابقة للبحث</td></tr>');
        } else {
            $("#no-results").remove();
        }
        
        // تحديث الإجماليات بعد البحث
        updateTotalsAfterSearch();
    });

    // البحث عند تغيير الفلتر
    $("select, input[type='date']").change(function() {
        $(this).closest("form").submit();
    });

    // تحديث الإجماليات بعد البحث أو التصفية
    function updateTotalsAfterSearch() {
        let pageTotal = 0;
        let visibleCount = 0;
        
        $(".sale-row:visible").each(function() {
            const saleId = $(this).find('.toggle-details').data('sale-id');
            const totalAmount = parseFloat($(`#details-${saleId} .fw-bold.text-primary`).last().text().replace(' ر.س', '').replace(',', ''));
            
            if (!isNaN(totalAmount)) {
                pageTotal += totalAmount;
                visibleCount++;
            }
        });
        
        // تحديث إجمالي الصفحة الحالية
        $(".page-total").text(pageTotal.toFixed(2) + " ر.س");
    }
});
</script>

<style>
.table {
    font-size: 0.9rem;
}

.table th {
    white-space: nowrap;
    background-color: #f8f9fa;
    color: #212529;
    position: sticky;
    top: 0;
    z-index: 10;
}

.sale-row {
    border-bottom: 2px solid #f1f1f1 !important;
}

.details-row {
    background-color: #f9f9f9;
}

.barcode-item {
    background: #ffffff;
    border-radius: 4px;
    padding: 6px 10px;
    border: 1px solid #dee2e6;
    display: flex;
    align-items: center;
}

.barcode-value {
    font-family: monospace;
    font-size: 1em;
    margin: 0 5px;
}

.copy-btn {
    padding: 0.1rem 0.3rem;
    font-size: 0.7rem;
}

.toggle-details {
    transition: all 0.3s ease;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.toggle-details i {
    transition: transform 0.3s ease;
}

/* تنسيق الترقيم */
.pagination {
    font-size: 0.9rem;
}

.page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.page-link {
    color: #0d6efd;
    padding: 0.5rem 0.75rem;
    transition: all 0.3s ease;
}

.page-link:hover {
    color: #0a58ca;
    background-color: #f8f9fa;
}

.page-item:first-child .page-link {
    border-top-right-radius: 0.25rem;
    border-bottom-right-radius: 0.25rem;
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

.page-item:last-child .page-link {
    border-top-left-radius: 0.25rem;
    border-bottom-left-radius: 0.25rem;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

/* تنسيق تذييل الجدول */
tfoot {
    background-color: #f8f9fa;
    font-weight: bold;
}

tfoot .row {
    margin-left: 0;
    margin-right: 0;
}

@media (max-width: 768px) {
    .table-responsive {
        overflow-x: auto;
        display: block;
        width: 100%;
    }
    
    .barcode-item {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .details-row td {
        padding: 0 !important;
    }
    
    .details-row .col-md-3 {
        margin-bottom: 0.5rem;
    }
    
    .pagination {
        flex-wrap: wrap;
    }
    
    .page-item {
        margin: 2px;
    }
    
    tfoot .row {
        flex-direction: column;
    }
    
    tfoot .col-md-6 {
        width: 100%;
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}

<!--القالب المعتمد  يوجد بعض الاخطاء -->