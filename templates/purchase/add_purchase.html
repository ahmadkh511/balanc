{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4 text-center text-primary">إنشاء فاتورة مشتريات جديدة</h1>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}


        <!-- معلومات الفاتورة -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">معلومات الفاتورة</div>
                        <div class="card-body">
                            <!-- السطر الأول: التاريخ -->
                            <div class="row mb-3">
                                <div class="col-md-2">
                                    <label for="date" class="form-label">التاريخ:</label>
                                    <input type="date" name="date" class="form-control" required id="date" value="{{ today }}">
                                </div>
                            </div>
                            
                            <!-- السطر الثاني: المورد، رقم الهاتف، العنوان -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="supplier" class="form-label">المورد:</label>
                                    <input type="text" id="supplier" class="form-control" required>
                                    <input type="hidden" id="supplier_id" name="supplier_id">
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="phone_number" class="form-label">رقم الهاتف:</label>
                                    <input type="text" name="supplier_phone" class="form-control" id="phone_number">
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="address" class="form-label">العنوان:</label>
                                    <textarea name="purchase_address" class="form-control" rows="1" id="address"></textarea>
                                </div>
                            </div>
                            
                            <!-- السطر الثالث: طريقة الدفع، العملة، حالة الفاتورة -->
                             
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="payment_method" class="form-label">طريقة الدفع:</label>
                                    <div class="input-group">
                                        <select name="payment_method" id="payment_method" class="form-select" required>
                                            {% for method in payment_methods %}
                                                <option value="{{ method.id }}" {% if method.payment_method_name == "نقدا" %}selected{% endif %}>
                                                    {{ method.payment_method_name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addPaymentMethodModal">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="currency" class="form-label">العملة:</label>
                                    <div class="input-group">
                                        <select name="currency" id="currency" class="form-select" required>
                                            {% for currency in currencies %}
                                                <option value="{{ currency.id }}" {% if currency.currency_name == "الليرة السورية" %}selected{% endif %}>
                                                    {{ currency.currency_name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addCurrencyModal">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="status" class="form-label">حالة الفاتورة:</label>
                                    <div class="input-group">
                                        <select name="status" id="status" class="form-select" required>
                                            {% for status in statuses %}
                                                <option value="{{ status.id }}" {% if status.status_types == "غير مدفوعة" %}selected{% endif %}>
                                                    {{ status.status_types }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addStatusModal">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- السطر الرابع: الملاحظات -->
                            <div class="row">
                                <div class="col-md-12">
                                    <label for="notes" class="form-label">الملاحظات:</label>
                                    <textarea name="notes" class="form-control" rows="2" id="notes"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>




            <!-- عناصر الفاتورة -->
            <div class="row mb-2">  <!-- تغيير من mb-4 إلى mb-2 لتقليل المسافة -->
                <div class="col-md-12">
                    <div class="card shadow-sm">  <!-- shadow-sm بدل shadow لتقليل الظل -->
                        <div class="card-header bg-secondary text-white py-2">  <!-- py-2 لتقليل ارتفاع الهيدر -->
                            <div class="d-flex justify-content-between align-items-center">
                                <span>عناصر الفاتورة</span>
                                <div class="d-flex" style="width: 300px;">
                                    <input type="number" id="number-of-rows" class="form-control form-control-sm" min="1" value="1" style="width: 70px;">
                                    <button type="button" id="generate-rows" class="btn btn-primary btn-sm ms-2">
                                        <i class="fas fa-plus-circle"></i> إنشاء الأسطر
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-2">  <!-- p-2 لتقليل المساحة الداخلية -->
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered table-hover mb-1" id="purchase-items-table">  <!-- table-sm و mb-1 لتقليل الحجم -->
                                    <thead class="table-dark">
                                        <tr>
                                            <th width="25%">الصنف</th>
                                            <th width="10%">الكمية</th>
                                            <th width="15%">سعر الوحدة</th>
                                            <th width="30%">الباركودات</th>
                                            <th width="10%">المجموع</th>
                                            <th width="10%">الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- صف إدخال البيانات -->
                                        <tr id="item-row-template" style="display: none;">
                                            <td>
                                                <input type="text" name="item_name_0" class="form-control form-control-sm item-name" placeholder="اسم الصنف">
                                                <input type="hidden" name="item_id_0" class="item-id">
                                            </td>
                                            <td><input type="number" name="quantity_0" class="form-control form-control-sm quantity" placeholder="الكمية" value="0"></td>
                                            <td><input type="number" name="unit_price_0" class="form-control form-control-sm unit-price" placeholder="سعر الوحدة" value="0"></td>
                                            <td>
                                                <div class="barcode-container">
                                                    <div class="barcode-inputs d-flex flex-wrap gap-1">  <!-- gap-1 لتقليل المسافة -->
                                                        <!-- الباركود الرئيسي -->
                                                        <div class="main-barcode w-100">
                                                            <input type="text" name="barcode_{{ itemIndex }}_0" 
                                                                class="form-control form-control-sm barcode" placeholder="الباركود الرئيسي">
                                                            <input type="hidden" name="barcode_id_{{ itemIndex }}_0" class="barcode-id">
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><input type="number" name="total_0" class="form-control form-control-sm item-total" placeholder="المجموع" readonly></td>
                                            <td><button type="button" class="btn btn-danger btn-sm remove-item py-1"><i class="fas fa-trash"></i> حذف</button></td>
                                        </tr>
                                        <!-- سيتم إضافة الصفوف هنا -->
                                    </tbody>
                                </table>
                            </div>
                            <button type="button" id="add-item" class="btn btn-primary btn-sm mt-1">  <!-- btn-sm و mt-1 -->
                                <i class="fas fa-plus"></i> إضافة عنصر
                            </button>
                        </div>
                    </div>
                </div>
            </div>



            <!-- تفاصيل وملخص الفاتورة -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card shadow">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <span>تفاصيل وملخص الفاتورة</span>
                            <div class="d-flex">
                                <span class="badge bg-light text-dark me-2">عدد الأصناف: <strong class="text-primary">0</strong></span>
                                <span class="badge bg-light text-dark me-2">الحالة: <strong class="text-primary">غير مدفوعة</strong></span>
                                <span class="badge bg-light text-dark me-2">الدفع: <strong class="text-primary">نقدا</strong></span>
                                <span class="badge bg-light text-dark">العملة: <strong class="text-primary">الليرة السورية</strong></span>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- تفاصيل الفاتورة -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="global-discount" class="form-label">الخصم العام:</label>
                                        <input type="number" id="global-discount" name="global_discount" class="form-control" placeholder="الخصم" value="0">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="global-addition" class="form-label">الإضافة العامة:</label>
                                        <input type="number" id="global-addition" name="global_addition" class="form-control" placeholder="الإضافة" value="0">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="global-tax" class="form-label">الضريبة العامة (%):</label>
                                        <input type="number" id="global-tax" name="global_tax" class="form-control" placeholder="الضريبة" value="0">
                                    </div>
                                </div>
                            </div>

                            <!-- ملخص الحسابات -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="invoice-details p-3 bg-light rounded">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="fw-bold">قيمة السلع:</span>
                                            <span id="subtotal-amount">0.00</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="fw-bold">الضريبة (<span id="tax-percentage">0%</span>):</span>
                                            <span id="total-tax">0.0000</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2 border-bottom pb-2">
                                            <span class="fw-bold">المجموع بعد الضريبة:</span>
                                            <span id="after-discount-addition">0.0000</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="invoice-details p-3 bg-light rounded">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="fw-bold">الإضافة العامة:</span>
                                            <span class="text-success">+ <span id="total-addition">0.00</span></span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="fw-bold">الخصم العام:</span>
                                            <span class="text-danger">- <span id="total-discount">0.00</span></span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center py-3">
                                            <span class="fw-bold fs-5">المجموع النهائي:</span>
                                            <span class="fw-bold fs-4 text-primary" id="grand-total">0.0000</span>
                                        </div>
                                        <input type="hidden" id="final-total" name="final_total" value="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- الأزرار -->
        <div class="row">
            <div class="col-md-12 text-center">
                <button type="submit" class="btn btn-success btn-lg me-2">
                    <i class="fas fa-save"></i> حفظ الفاتورة
                </button>
                <a href="{% url 'purchase_list' %}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times"></i> إلغاء
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Modal لإضافة طريقة دفع جديدة -->
<div class="modal fade" id="addPaymentMethodModal" tabindex="-1" aria-labelledby="addPaymentMethodModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addPaymentMethodModalLabel">إضافة طريقة دفع جديدة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPaymentMethodForm">
                    <div class="mb-3">
                        <label for="payment_method_name" class="form-label">اسم طريقة الدفع:</label>
                        <input type="text" id="payment_method_name" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" id="savePaymentMethod">حفظ</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal لإضافة عملة جديدة -->
<div class="modal fade" id="addCurrencyModal" tabindex="-1" aria-labelledby="addCurrencyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="addCurrencyModalLabel">إضافة عملة جديدة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCurrencyForm">
                    <div class="mb-3">
                        <label for="currency_name" class="form-label">اسم العملة:</label>
                        <input type="text" id="currency_name" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" id="saveCurrency">حفظ</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal لإضافة حالة فاتورة جديدة -->
<div class="modal fade" id="addStatusModal" tabindex="-1" aria-labelledby="addStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="addStatusModalLabel">إضافة حالة فاتورة جديدة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addStatusForm">
                    <div class="mb-3">
                        <label for="status_types" class="form-label">حالة الفاتورة:</label>
                        <input type="text" id="status_types" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" id="saveStatus">حفظ</button>
            </div>
        </div>
    </div>
</div>

<!-- روابط المكتبات المطلوبة -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// تعريف الدوال في النطاق العام أولاً
function calculateGrandTotal() {
    const table = document.getElementById('purchase-items-table');
    let subtotal = 0;
    let itemCount = 0;

    // 1. حساب قيمة السلع الأساسية (مجموع كميات × أسعار)
    table.querySelectorAll('tbody tr').forEach(row => {
        if (row.style.display !== 'none' && !row.id.includes('item-row-template')) {
            itemCount++;
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
            const itemTotal = quantity * unitPrice;
            
            row.querySelector('.item-total').value = itemTotal.toFixed(2);
            subtotal += itemTotal;
        }
    });

    // 2. حساب الضريبة (على قيمة السلع فقط)
    const globalTaxPercentage = parseFloat(document.getElementById('global-tax').value) || 0;
    const taxAmount = subtotal * (globalTaxPercentage / 100);
    
    // 3. المجموع بعد الضريبة
    const afterTax = subtotal + taxAmount;
    
    // 4. تطبيق الإضافة العامة
    const globalAddition = parseFloat(document.getElementById('global-addition').value) || 0;
    
    // 5. تطبيق الخصم العام
    const globalDiscount = parseFloat(document.getElementById('global-discount').value) || 0;
    
    // 6. حساب المجموع النهائي
    const finalTotal = afterTax + globalAddition - globalDiscount;

    // تحديث القيم المعروضة حسب الترتيب المطلوب
    document.getElementById('subtotal-amount').textContent = subtotal.toFixed(2); // قيمة السلع
    document.getElementById('total-tax').textContent = taxAmount.toFixed(4);      // الضريبة
    document.getElementById('after-discount-addition').textContent = afterTax.toFixed(4); // بعد الضريبة
    document.getElementById('total-addition').textContent = globalAddition.toFixed(2);    // الإضافة
    document.getElementById('total-discount').textContent = globalDiscount.toFixed(2);    // الخصم
    document.getElementById('grand-total').textContent = finalTotal.toFixed(4);           // النهائي
    document.getElementById('tax-percentage').textContent = globalTaxPercentage + '%';    // نسبة الضريبة
    
    // الحقل المخفي لحفظ القيمة النهائية
    document.getElementById('final-total').value = finalTotal.toFixed(2);

    // تحديث ملخص الفاتورة
    updateInvoiceSummary(itemCount, finalTotal);
}

function updateInvoiceSummary(itemCount, finalTotal) {
    const summaryElement = document.getElementById('invoice-summary');
    const statusText = document.getElementById('status').options[document.getElementById('status').selectedIndex].text;
    const paymentText = document.getElementById('payment_method').options[document.getElementById('payment_method').selectedIndex].text;
    const currencyText = document.getElementById('currency').options[document.getElementById('currency').selectedIndex].text;
    
    let summaryHTML = `
        <div class="col-md-3">
            <p>عدد الأصناف: <strong class="text-primary">${itemCount}</strong></p>
        </div>
        <div class="col-md-3">
            <p>حالة الفاتورة: <strong class="text-primary">${statusText}</strong></p>
        </div>
        <div class="col-md-3">
            <p>طريقة الدفع: <strong class="text-primary">${paymentText}</strong></p>
        </div>
        <div class="col-md-3">
            <p>العملة: <strong class="text-primary">${currencyText}</strong></p>
        </div>
        <div class="col-12 mt-2">
            <p class="total-summary">المجموع النهائي: <strong class="text-success">${finalTotal.toFixed(2)}</strong></p>
        </div>
    `;
    
    summaryElement.innerHTML = summaryHTML;
}

// تحديث حقول الباركود بناءً على الكمية
function updateBarcodeFields(row, quantity) {
    const barcodeContainer = row.querySelector('.barcode-inputs');
    const itemIndex = row.dataset.index;
    
    // حذف جميع حقول الباركود الإضافية (نحتفظ بالرئيسي فقط)
    const mainBarcode = barcodeContainer.querySelector('.main-barcode');
    barcodeContainer.innerHTML = '';
    barcodeContainer.appendChild(mainBarcode);
    
    // إنشاء حقول الباركود الجديدة (عددها = الكمية - 1 لأن لدينا حقل رئيسي)
    for (let i = 1; i < quantity; i++) {
        const barcodeDiv = document.createElement('div');
        barcodeDiv.className = 'additional-barcode w-100';
        barcodeDiv.innerHTML = `
            <div class="input-group mb-2">
                <input type="text" name="barcode_${itemIndex}_${i}" 
                       class="form-control barcode" placeholder="باركود ${i + 1}">
                <input type="hidden" name="barcode_id_${itemIndex}_${i}" class="barcode-id">
            </div>
        `;
        barcodeContainer.appendChild(barcodeDiv);
        
        // تفعيل الإكمال التلقائي للباركود الجديد
        $(barcodeDiv.querySelector('.barcode')).autocomplete({
            source: "{% url 'autocomplete_barcodes' %}",
            minLength: 2,
            select: function(event, ui) {
                $(this).val(ui.item.label);
                return false;
            }
        });
    }
}

// تهيئة الأحداث عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function () {
    const table = document.getElementById('purchase-items-table');
    const addButton = document.getElementById('add-item');
    const generateRowsButton = document.getElementById('generate-rows');
    const numberOfRowsInput = document.getElementById('number-of-rows');
    let itemCounter = 0;

    // الإكمال التلقائي للموردين
    $("#supplier").autocomplete({
        source: "{% url 'autocomplete_suppliers' %}",
        minLength: 2,
        select: function(event, ui) {
            $("#supplier_id").val(ui.item.id); // تعيين قيمة الحقل المخفي
            $("#supplier").val(ui.item.label); // تعيين نص الحقل الظاهر
            return false;
        }
    });

    // الإكمال التلقائي للأصناف
    $(document).on('focus', ".item-name", function() {
        $(this).autocomplete({
            source: "{% url 'autocomplete_items' %}",
            minLength: 2,
            select: function(event, ui) {
                $(this).val(ui.item.label);
                $(this).closest('tr').find('.item-id').val(ui.item.id);
                $(this).closest('tr').find('.unit-price').val(ui.item.price);
                calculateRowTotal($(this).closest('tr')[0]);
                return false;
            }
        });
    });

    // الإكمال التلقائي للباركود
    $(document).on('focus', ".barcode", function() {
        $(this).autocomplete({
            source: "{% url 'autocomplete_barcodes' %}",
            minLength: 2,
            select: function(event, ui) {
                $(this).val(ui.item.label);
                return false;
            }
        });
    });

    // إضافة صف جديد
    function addRow() {
        const templateRow = document.getElementById('item-row-template');
        const newRow = templateRow.cloneNode(true);
        newRow.style.display = '';
        newRow.removeAttribute('id');
        newRow.dataset.index = itemCounter;
        
        newRow.querySelectorAll('[name]').forEach(input => {
            const name = input.name;
            const newName = name.replace(/_(\d+)/, `_${itemCounter}`);
            input.name = newName;
            
            if (name.startsWith('barcode_')) {
                const parts = name.split('_');
                if (parts.length === 3) {
                    input.name = `barcode_${itemCounter}_${parts[2]}`;
                }
            }
        });
        
        // إضافة حدث لتغيير الكمية
        const quantityInput = newRow.querySelector('.quantity');
        quantityInput.addEventListener('change', function() {
            const quantity = parseInt(this.value) || 1;
            if (quantity < 1) {
                this.value = 1;
                return;
            }
            updateBarcodeFields(newRow, quantity);
            calculateRowTotal(newRow);
        });
        
        // إضافة أحداث لحساب المجموع عند تغيير السعر
        newRow.querySelector('.unit-price').addEventListener('input', function() {
            calculateRowTotal(newRow);
        });
        
        table.querySelector('tbody').appendChild(newRow);
        
        // تحديث حقول الباركود بناء على الكمية الابتدائية (1)
        updateBarcodeFields(newRow, 1);
        
        itemCounter++;
        calculateRowTotal(newRow);
    }

    // حساب مجموع الصف
    function calculateRowTotal(row) {
        const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
        const total = quantity * unitPrice;
        
        row.querySelector('.item-total').value = total.toFixed(2);
        calculateGrandTotal();
    }

    // إنشاء عدد الأسطر المطلوبة
    generateRowsButton.addEventListener('click', function () {
        const numberOfRows = parseInt(numberOfRowsInput.value) || 1;
        if (numberOfRows > 0) {
            for (let i = 0; i < numberOfRows; i++) {
                addRow();
            }
        }
    });

    // إضافة صف عند الضغط على زر "إضافة عنصر"
    addButton.addEventListener('click', addRow);

    // حذف صف
    table.addEventListener('click', function (event) {
        if (event.target.classList.contains('remove-item')) {
            event.target.closest('tr').remove();
            calculateGrandTotal();
        }
    });

    // حساب الإجمالي عند تغيير القيم العامة
    document.getElementById('global-discount').addEventListener('input', calculateGrandTotal);
    document.getElementById('global-addition').addEventListener('input', calculateGrandTotal);
    document.getElementById('global-tax').addEventListener('input', calculateGrandTotal);

    // تحديث عند تغيير حالة الفاتورة أو طريقة الدفع
    document.getElementById('status').addEventListener('change', function() {
        updateInvoiceSummary(
            document.querySelectorAll('#purchase-items-table tbody tr:not([style*="none"]):not([id*="item-row-template"])').length,
            parseFloat(document.getElementById('grand-total').textContent) || 0
        );
    });
    
    document.getElementById('payment_method').addEventListener('change', function() {
        updateInvoiceSummary(
            document.querySelectorAll('#purchase-items-table tbody tr:not([style*="none"]):not([id*="item-row-template"])').length,
            parseFloat(document.getElementById('grand-total').textContent) || 0
        );
    });
    
    document.getElementById('currency').addEventListener('change', function() {
        updateInvoiceSummary(
            document.querySelectorAll('#purchase-items-table tbody tr:not([style*="none"]):not([id*="item-row-template"])').length,
            parseFloat(document.getElementById('grand-total').textContent) || 0
        );
    });


    
    // إضافة حدث لحفظ طريقة الدفع مع الإغلاق الصحيح
    document.getElementById('savePaymentMethod').addEventListener('click', function() {
        const paymentMethodName = document.getElementById('payment_method_name').value;
        
        if (!paymentMethodName) {
            alert('الرجاء إدخال اسم طريقة الدفع');
            return;
        }
        
        fetch("{% url 'payment_method_create' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `payment_method_name=${encodeURIComponent(paymentMethodName)}&payment_method_notes=`
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // تحديث القائمة المنسدلة
                const select = document.getElementById('payment_method');
                const option = document.createElement('option');
                option.value = data.id;
                option.textContent = data.name;
                select.appendChild(option);
                option.selected = true;
                
                // الإغلاق الصحيح للمودال مع إصلاح السكرول
                const modal = document.getElementById('addPaymentMethodModal');
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
                
                // تنظيف DOM بعد إغلاق المودال
                document.body.classList.remove('modal-open');
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                
                // إعادة تفعيل السكرول
                document.body.style.overflow = 'auto';
                document.body.style.paddingRight = '0';
                
                // إعادة تعيين النموذج
                document.getElementById('addPaymentMethodForm').reset();
                
                // تحديث الملخص
                updateInvoiceSummary(
                    document.querySelectorAll('#purchase-items-table tbody tr:not([style*="none"]):not([id*="item-row-template"])').length,
                    parseFloat(document.getElementById('grand-total').textContent) || 0
                );
            } else {
                alert('حدث خطأ أثناء حفظ طريقة الدفع: ' + (data.errors || ''));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء حفظ طريقة الدفع: ' + error.message);
        });
    });

    // إضافة حدث لحفظ العملة مع الإغلاق الصحيح
    document.getElementById('saveCurrency').addEventListener('click', function() {
        const currencyName = document.getElementById('currency_name').value;
        
        if (!currencyName) {
            alert('الرجاء إدخال اسم العملة');
            return;
        }
        
        fetch("{% url 'currency_create' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `currency_name=${encodeURIComponent(currencyName)}&description=`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // تحديث القائمة المنسدلة
                const select = document.getElementById('currency');
                const option = document.createElement('option');
                option.value = data.id;
                option.textContent = data.name;
                select.appendChild(option);
                option.selected = true;
                
                // الإغلاق الصحيح للمودال مع إصلاح السكرول
                const modal = document.getElementById('addCurrencyModal');
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
                
                document.body.classList.remove('modal-open');
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                
                document.body.style.overflow = 'auto';
                document.body.style.paddingRight = '0';
                
                // إعادة تعيين النموذج
                document.getElementById('addCurrencyForm').reset();
                
                // تحديث الملخص
                updateInvoiceSummary(
                    document.querySelectorAll('#purchase-items-table tbody tr:not([style*="none"]):not([id*="item-row-template"])').length,
                    parseFloat(document.getElementById('grand-total').textContent) || 0
                );
            } else {
                alert('حدث خطأ أثناء حفظ العملة');
            }
        });
    });

    // إضافة حدث لحفظ حالة الفاتورة مع الإغلاق الصحيح
    document.getElementById('saveStatus').addEventListener('click', function() {
        const statusTypes = document.getElementById('status_types').value;
        
        if (!statusTypes) {
            alert('الرجاء إدخال حالة الفاتورة');
            return;
        }
        
        fetch("{% url 'status_create' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `status_types=${encodeURIComponent(statusTypes)}&status_description=`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // تحديث القائمة المنسدلة
                const select = document.getElementById('status');
                const option = document.createElement('option');
                option.value = data.id;
                option.textContent = data.name;
                select.appendChild(option);
                option.selected = true;
                
                // الإغلاق الصحيح للمودال مع إصلاح السكرول
                const modal = document.getElementById('addStatusModal');
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
                
                document.body.classList.remove('modal-open');
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                
                document.body.style.overflow = 'auto';
                document.body.style.paddingRight = '0';
                
                // إعادة تعيين النموذج
                document.getElementById('addStatusForm').reset();
                
                // تحديث الملخص
                updateInvoiceSummary(
                    document.querySelectorAll('#purchase-items-table tbody tr:not([style*="none"]):not([id*="item-row-template"])').length,
                    parseFloat(document.getElementById('grand-total').textContent) || 0
                );
            } else {
                alert('حدث خطأ أثناء حفظ حالة الفاتورة');
            }
        });
    });

    // إضافة أحداث لإغلاق المودال بشكل صحيح عند النقر خارجها
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function () {
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
            document.body.style.overflow = 'auto';
            document.body.style.paddingRight = '0';
        });
    });



// نهاية كود اضافة العملة و حالة الفاتورة و طريقة الدفع 

    // إضافة صف أول عند تحميل الصفحة
    addRow();
});
</script>

<style>
/* تخصيصات عامة */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f5f5;
}

.container {
    max-width: 1200px;
}

.card {
    border-radius: 10px;
    border: none;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
    font-weight: bold;
    padding: 15px 20px;
    font-size: 1.1rem;
}

.form-control, .form-select {
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ced4da;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.btn {
    padding: 8px 15px;
    border-radius: 5px;
    font-weight: 500;
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-success {
    background-color: #198754;
    border-color: #198754;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
}

.btn-lg {
    padding: 10px 20px;
    font-size: 1.1rem;
}

/* تخصيصات الجدول */
.table {
    margin-bottom: 0;
}

.table thead th {
    background-color: #343a40;
    color: white;
    border-bottom: none;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.03);
}

/* تخصيصات حقول الباركود */
.barcode-container {
    min-width: 200px;
}

.additional-barcode {
    margin-top: 5px;
}

.main-barcode {
    margin-bottom: 10px;
}

/* تخصيصات تفاصيل الفاتورة */
.invoice-details {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid #dee2e6;
}

.invoice-details p {
    margin-bottom: 8px;
    font-size: 16px;
}

.invoice-details strong {
    color: #2c3e50;
}

.total-summary {
    font-size: 1.2rem;
    font-weight: bold;
    color: #2c3e50;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #ddd;
}

/* تخصيصات الإكمال التلقائي */
.ui-autocomplete {
    max-height: 200px;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 5px 0;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
    z-index: 1051 !important;
}

.ui-menu-item {
    padding: 3px 15px;
    font-size: 14px;
}

.ui-menu-item:hover {
    background-color: #f5f5f5;
    cursor: pointer;
}

.ui-state-focus {
    background-color: #e9ecef !important;
    border-color: #ddd;
    color: #495057;
}

/* تخصيصات المودال */
.modal-header {
    border-bottom: none;
    padding-bottom: 0;
}

.modal-footer {
    border-top: none;
    padding-top: 0;
}

/* تخصيصات الأزرار في الجدول */
.btn-sm {
    padding: 5px 10px;
    font-size: 0.875rem;
}

/* تخصيصات الإدخال في الجدول */
.table input.form-control {
    padding: 5px 10px;
    height: auto;
}

/* تخصيصات للعناصر الصغيرة */
.input-group-text {
    padding: 8px 12px;
}

/* تخصيصات للأجهزة الصغيرة */
@media (max-width: 768px) {
    .card-body {
        padding: 15px;
    }
    
    .invoice-details {
        padding: 10px;
    }
    
    .btn-lg {
        padding: 8px 15px;
        font-size: 1rem;
    }
}
</style>

{% endblock %}