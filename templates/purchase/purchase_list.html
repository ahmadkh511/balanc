{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-5">
    <h1 class="mb-4 text-center">قائمة فواتير المشتريات</h1>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{% url 'purchase_create' %}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus"></i> إنشاء فاتورة جديدة
        </a>
        <div>
            <!-- زر تبديل الأسلوب -->
            <button id="toggle-view" class="btn btn-secondary btn-sm mr-2">
                <i class="fas fa-list"></i> تفصيلي
            </button>
            <button id="expandAll" class="btn btn-secondary btn-sm" title="فتح/إغلاق جميع البنود">
                <i class="fas fa-expand-arrows-alt"></i>
            </button>
            <button id="printAll" class="btn btn-success btn-sm ml-2" title="طباعة الكشف">
                <i class="fas fa-print"></i>
            </button>
            <input type="text" id="searchInput" class="form-control w-25 d-inline-block ml-2" placeholder="بحث...">
        </div>
    </div>

    <!-- جدول الفواتير (التفصيلي) -->
    <div id="detailed-view" class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th></th>  <!-- عمود الزر + -->
                    <th>رقم الفاتورة</th>
                    <th>المورد</th>
                    <th>تاريخ الإنشاء</th>
                    <th>طريقة الدفع</th>
                    <th>حالة الفاتورة</th>
                    <th>طريقة الاستلام</th>
                    <th>رقم الاستلام</th>
                    <th>العملة</th>
                    <th>ملاحظات</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for purchase in purchases %}
                    <tr data-purchase-id="{{ purchase.id }}" class="purchase-row">
                        <td>
                            <button class="btn btn-sm btn-toggle" data-toggle="collapse" data-target="#items-{{ purchase.id }}">
                                <i class="fas fa-plus"></i>
                            </button>
                        </td>
                        <td>{{ purchase.uniqueId }}</td>
                        <td>{{ purchase.supplier.username }}</td>
                        <td>{{ purchase.date_created|date:"Y-m-d" }}</td>
                        <td>{{ purchase.payment_method }}</td>
                        <td>
                            <span class="badge {% if purchase.status == 'مدفوعة' %}bg-success{% else %}bg-warning{% endif %}">
                                {{ purchase.status|default:"غير مدفوعة" }}
                            </span>
                        </td>
                        <td>{{ purchase.receiving_method }}</td>
                        <td>{{ purchase.receiving_number }}</td>
                        <td>{{ purchase.currency.currency_name }}</td>
                        <td>{{ purchase.notes|truncatechars:20 }}</td>
                        <td>
                            <a href="{% url 'purchase_detail' purchase.pk %}" class="btn btn-info btn-sm" title="عرض">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{% url 'purchase_update' purchase.pk %}" class="btn btn-warning btn-sm" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'purchase_delete' purchase.pk %}" class="btn btn-danger btn-sm" title="حذف">
                                <i class="fas fa-trash"></i>
                            </a>
                            <button class="btn btn-success btn-sm print-purchase" title="طباعة" data-purchase-id="{{ purchase.id }}">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    </tr>
                    <!-- تفاصيل البنود -->
                    <tr id="items-{{ purchase.id }}" class="collapse">
                        <td colspan="11">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>الصنف</th>
                                        <th>الكمية</th>
                                        <th>سعر الوحدة</th>
                                        <th>الخصم</th>
                                        <th>الإضافة</th>
                                        <th>الضريبة</th>
                                        <th>الباركود</th>  <!-- عمود الباركود الجديد -->
                                        <th>المجموع</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in purchase.items.all %}
                                        <tr>
                                            <td>{{ item.item_name }}</td>
                                            <td>{{ item.quantity }}</td>
                                            <td>{{ item.unit_price }}</td>
                                            <td>{{ item.discount }}</td>
                                            <td>{{ item.addition }}</td>
                                            <td>{{ item.tax }}</td>
                                            <td>{{ item.barcode.barcode_in }}</td>  <!-- عرض الباركود -->
                                            <td>{{ item.total }}</td>
                                        </tr>
                                    {% endfor %}
                                    <!-- مجموع الفاتورة -->
                                    <tr class="table-info">
                                        <td colspan="7" class="text-right"><strong>مجموع الفاتورة:</strong></td>
                                        <td><strong>{{ purchase.total_amount }}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="11" class="text-center">لا توجد فواتير لعرضها.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- جدول الفواتير (الإجمالي) -->
    <div id="summary-view" class="table-responsive" style="display: none;">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th></th>  <!-- عمود الزر + -->
                    <th>رقم الفاتورة</th>
                    <th>المورد</th>
                    <th>تاريخ الإنشاء</th>
                    <th>حالة الفاتورة</th>
                    <th>المجموع</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for purchase in purchases %}
                    <tr>
                        <td>
                            <a href="{% url 'purchase_detail' purchase.pk %}" class="btn btn-sm btn-toggle" title="عرض التفاصيل">
                                <i class="fas fa-plus"></i>
                            </a>
                        </td>
                        <td>{{ purchase.uniqueId }}</td>
                        <td>{{ purchase.supplier.username }}</td>
                        <td>{{ purchase.date_created|date:"Y-m-d" }}</td>
                        <td>
                            <span class="badge {% if purchase.status == 'مدفوعة' %}bg-success{% else %}bg-warning{% endif %}">
                                {{ purchase.status|default:"غير مدفوعة" }}
                            </span>
                        </td>
                        <td>{{ purchase.total_amount }}</td>
                        <td>
                            <a href="{% url 'purchase_detail' purchase.pk %}" class="btn btn-info btn-sm" title="عرض">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{% url 'purchase_update' purchase.pk %}" class="btn btn-warning btn-sm" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'purchase_delete' purchase.pk %}" class="btn btn-danger btn-sm" title="حذف">
                                <i class="fas fa-trash"></i>
                            </a>
                            <button class="btn btn-success btn-sm print-purchase" title="طباعة" data-purchase-id="{{ purchase.id }}">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">لا توجد فواتير لعرضها.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- عرض الإجمالي العام لجميع الفواتير -->
    <div class="d-flex justify-content-between align-items-center mt-4">
        <span><strong>إجمالي الفواتير العام: </strong>{{ total_amount }}</span>
    </div>

    <!-- عرض إجمالي الفواتير في الصفحة الحالية -->
    <div class="d-flex justify-content-between align-items-center mt-4">
        <span><strong>إجمالي هذه الصفحة: </strong>{{ page_total }}</span>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">
                    الصفحة {{ page_obj.number }} من {{ page_obj.paginator.num_pages }}
                </span>
            </li>

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- إضافة مكتبة Font Awesome للأيقونات -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- إضافة مكتبة jQuery للبحث -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- إضافة مكتبة Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function () {
        // وظيفة البحث
        $("#searchInput").on("keyup", function () {
            const value = $(this).val().toLowerCase();
            $("tbody tr[data-purchase-id]").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
        });

        // وظيفة فتح/إغلاق البنود
        $(".btn-toggle").click(function () {
            const icon = $(this).find("i");
            if (icon.hasClass("fa-plus")) {
                icon.removeClass("fa-plus").addClass("fa-minus");
            } else {
                icon.removeClass("fa-minus").addClass("fa-plus");
            }
        });

        // وظيفة فتح/إغلاق جميع البنود
        $("#expandAll").click(function () {
            const icon = $(this).find("i");
            if (icon.hasClass("fa-expand-arrows-alt")) {
                $(".collapse").collapse("show");
                icon.removeClass("fa-expand-arrows-alt").addClass("fa-compress-arrows-alt");
                $(".btn-toggle i").removeClass("fa-plus").addClass("fa-minus");
            } else {
                $(".collapse").collapse("hide");
                icon.removeClass("fa-compress-arrows-alt").addClass("fa-expand-arrows-alt");
                $(".btn-toggle i").removeClass("fa-minus").addClass("fa-plus");
            }
        });

        // وظيفة طباعة الكشف الكامل
        $("#printAll").click(function () {
            window.print();
        });

        // وظيفة طباعة فاتورة محددة
        $(".print-purchase").click(function () {
            const purchaseId = $(this).data("purchase-id");
            const printContents = document.getElementById("items-" + purchaseId).outerHTML;
            const originalContents = document.body.innerHTML;

            document.body.innerHTML = printContents;
            window.print();
            document.body.innerHTML = originalContents;
            location.reload();  // إعادة تحميل الصفحة لاستعادة المحتوى الأصلي
        });

        // وظيفة تبديل الأسلوب
        $("#toggle-view").click(function () {
            const icon = $(this).find("i");
            if (icon.hasClass("fa-list")) {
                // التبديل إلى الإجمالي
                $("#detailed-view").hide();
                $("#summary-view").show();
                icon.removeClass("fa-list").addClass("fa-table");
                $(this).html('<i class="fas fa-table"></i> تفصيلي');
            } else {
                // التبديل إلى التفصيلي
                $("#summary-view").hide();
                $("#detailed-view").show();
                icon.removeClass("fa-table").addClass("fa-list");
                $(this).html('<i class="fas fa-list"></i> إجمالي');
            }
        });
    });
</script>

<style>
    /* إضافة مسافة بين الفواتير */
    .purchase-row {
        margin-bottom: 10px;  /* يمكنك تعديل القيمة حسب الحاجة */
    }

    /* تنسيق مجموع الفاتورة */
    .table-info {
        background-color: #e9f7ff;  /* لون خلفية فاتح */
    }

    /* إضافة فاصل بين الصفوف */
    tr {
        border-bottom: 10px solid transparent;  /* مسافة بين الصفوف */
    }
</style>
{% endblock %}